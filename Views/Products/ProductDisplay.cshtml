@using Microsoft.AspNetCore.Identity
@inject SignInManager<IdentityUser> SignInManager
@inject UserManager<IdentityUser> UserManager
@{
	ViewData["Title"] = ViewBag.Id;
	var myAlert = ViewData["alert"];
	List<int> colorList = new List<int>();
	List<int> vList = new List<int>();
	List<int> sizeList = new List<int>();
	bool canEditReview = false;
	int yourReviewId = 0;
	// for view data
	// List<ProductImages> ProductImages = ViewData["productImages"] as List<ProductImages>;
	// List<Product> Product = ViewData["product"] as List<Product>;
}
<script type="text/javascript">

	var test = '@ViewData["Alert"]';
	console.log(test);
	window.onload = function () {
		if (test != null && test != "") {
			if (test) {
				alert("This product has been successfully added to your cart!");
			} else {
				alert("There was an error processing your request.");

			}
		}
	}
</script>

<br />
<br />
<br />

<div class="col-12 d-flex justify-content-center">
	<div class="container-fluid col-xl-11  m-0 d-flex flex-column align-items-center">
		<div style="max-width: 1400px; " class="row col-12 ">
			<div class="tests col-8">


				<div class=" filter-column   ">
					@foreach (ProductImages productImage in ViewBag.ProductImagesModel)
					{
						@foreach (Product product in ViewBag.ProductModel)
						{
							var temp = product.CategoryId;
							bool temp2 = temp == 1;
							if (temp2 && productImage.ProductId == product.Id && productImage.Id > 0 && ViewBag.Id == product.Id && ViewBag.colorId == productImage.colorId)
							{
								<ul class="product-display-list plain-list d-flex flex-column align-items-end justify-content-start">
									<li class="bg-dark">
										<img onmouseover="displayImage(this)" class=" product-display-list-image" src="@(productImage.Image1)" alt="product image for " />
									</li>
									@if (productImage.Image2 != null)
									{
										<li class="bg-dark">
											<img onmouseover="displayImage(this)" class="product-display-list-image" src="@(productImage.Image2)" alt="product image for " />
										</li>
									}
									@if (productImage.Image3 != null)
									{
										<li class="bg-dark">
											<img onmouseover="displayImage(this)" class="product-display-list-image" src="@(productImage.Image3)" alt="product image for " />
										</li>
									}
									@if (productImage.Image4 != null)
									{
										<li class="bg-dark">
											<img onmouseover="displayImage(this)" class="product-display-list-image" src="@(productImage.Image4)" alt="product image for " />
										</li>
									}
									@if (productImage.Image5 != null)
									{
										<li class="bg-dark">
											<img onmouseover="displayImage(this)" class="product-display-list-image" src="@(productImage.Image5)" alt="product image for " />
										</li>
									}
									@if (productImage.Image6 != null)
									{
										<li class="bg-dark">
											<img onmouseover="displayImage(this)" class="product-display-list-image" src="@(productImage.Image6)" alt="product image for " />
										</li>
									}

								</ul>
							}
						}
					}
				</div>
				<div style="width: 100%;" class=" filter-column  d-flex justify-content-center ">
					@foreach (ProductImages productImage in ViewBag.ProductImagesModel)
					{
						@foreach (Product product in ViewBag.ProductModel)
						{
							var temp = product.CategoryId;
							bool temp2 = temp == 1;
							if (temp2 && productImage.ProductId == product.Id && productImage.Id > 0 && ViewBag.Id == product.Id && ViewBag.ColorId == productImage.colorId)
							{
								<div id="product-display-image" class=" magnifier-thumb-wrapper position-relative">
									<img id="thumb" src="@(productImage.Image1)" alt="product image for " />
								</div>
							}
						}
					}
				</div>
			</div>


			<div class="  col-4">
				@foreach (ProductImages productImage in ViewBag.ProductImagesModel)
				{
					@foreach (Product product in ViewBag.ProductModel)
					{

						var temp = product.CategoryId;
						bool temp2 = temp == 1;


						if (temp2 && productImage.ProductId == ViewBag.Id && productImage.Id > 0 && ViewBag.ColorId == productImage.colorId && product.Id == ViewBag.Id)
						{
							<h2 class="mb-0">@(product.Name) </h2>
							<h5 class=" ">@((product.Sex == 'M') ? "Men's" : (product.Sex == 'W') ? "Women's" : "Unisex") @(product.Type)</h5>
							<h4 class="mt-3">$@(product.Price) </h4>
							var stock = (product.Stock > 30) ? "text-success" : (product.Stock > 15) ? "text-warning" : "text-danger";
							<h6 class="mt-3"><span class="@(stock)">@(product.Stock) left in stock</span></h6>



							<h5 class="mt-4">Select a Style:</h5>
							<ul class="color-list">
								@foreach (ProductVariations productVariation in ViewBag.Pe)
								{

									@if (productVariation.productId == product.Id)
									{
										if (colorList.Contains(productVariation.colorId))
										{

										}
										else
										{
											vList.Add(productVariation.Id);
											colorList.Add(productVariation.colorId);
										}
									}

								}


								@foreach (ProductVariations productVariation in ViewBag.Pe)
								{
									@foreach (ProductColors productColor in ViewBag.ProductColorsModel)
									{

										@foreach (int item in colorList)
										{

											@if (productColor.Id == item && productVariation.colorId == item && !vList.Contains(item) && productVariation.productId == ViewBag.Id)
											{

												vList.Add(item);


												<li class="color-list-item">
													@{
														bool isSelected2 = false;
														if (productVariation.colorId == ViewBag.ColorId)
														{
															isSelected2 = true;
														}
													}


													<a class="" asp-action="ProductDisplay" asp-route-id="@product.Id" asp-route-colorId="@item" asp-route-sizeId="@ViewBag.SizeId" asp-route-variationId="@productVariation.Id">
														@foreach (ProductImages productImage2 in ViewBag.ProductImagesModel)
														{
															if (productImage2.colorId == item && productVariation.productId == productImage2.ProductId)
															{

																<img class="@(isSelected2 ? "selected" : "")" src="@(productImage2.Image1)" />
															}
														}

													</a>

												</li>
											}
										}
									}
								}
							</ul>
							<h5 class="mt-4">Select a Size:</h5>
							<ul class="size-list">
								@foreach (ProductVariations productVariation in ViewBag.Pe)
								{
									@foreach (ProductColors productColor in ViewBag.ProductColorsModel)
									{
										if (productVariation.productId == ViewBag.Id && productVariation.colorId == ViewBag.ColorId && productImage.colorId == productVariation.colorId && !sizeList.Contains(productVariation.sizeId))
										{
											sizeList.Add(productVariation.sizeId);
											<li class="size-list-item">

												@foreach (ProductSizes productSize in ViewBag.ProductSizesModel)
												{
													if (productSize.Id == productVariation.sizeId)
													{
														bool isSelected = false;
														if (productVariation.Id == ViewBag.vId && productVariation.colorId == ViewBag.ColorId && productVariation.sizeId == ViewBag.SizeId)
														{
															isSelected = true;
														}

														<a class="@(isSelected ? "selected" : "") fill d-flex justify-content-center align-content-center flex-wrap text-decoration-none" asp-action="ProductDisplay" asp-route-id="@product.Id" asp-route-colorId="@productVariation.colorId" asp-route-sizeId="@productVariation.sizeId" asp-route-variationId="@productVariation.Id">

															<h5>@productSize.Size</h5>
														</a>
													}

												}
											</li>
										}

									}
								}

							</ul>
							<h6 class="mt-4">Shipping</h6>
							<p>View our shipping options at checkout.</p>
							@foreach (ProductVariations productVariation in ViewBag.Pe)
							{


								if (productVariation.Id == ViewBag.vId && productVariation.colorId == ViewBag.ColorId && productVariation.sizeId == ViewBag.SizeId)
								{
									<a class="tocart-button mt-4" asp-controller="ShoppingCart" asp-action="AddToCart" asp-route-quantity="1" asp-route-variationId="@(productVariation.Id)" asp-route-totalCost="@(product.Price)" asp-route-cartItemId="@(product.Id)" asp-route-cId="@(ViewBag.ColorId)" asp-route-sId="@(ViewBag.SizeId)" asp-route-vId="@(ViewBag.vId)" onclick="">
										<p class="text-black fs-6 mb-0">Add to Cart</p>
									</a>
								}

							}
							<p class="mt-4">@(product.Description)</p>
							<ul class="mt-4">
								<li>
									@foreach (ProductColors productColor in ViewBag.ProductColorsModel)
									{
										@foreach (ProductVariations productVariation in ViewBag.Pe)
										{
											if (ViewBag.colorId == productColor.Id && productVariation.colorId == productColor.Id && productVariation.Id == ViewBag.vId)
											{
												<p>Style shown: @(productColor.Color)</p>
											}
										}
									}
								</li>
								<li>
									<p class="">Product ID: @(product.Id)</p>
								</li>
							</ul>

							<div class="accordion accordion-flush myaccordian mb-4 mt-4" id="accordionFlushExample">
								<div class="accordion-item">
									<h2 class="accordion-header">
										<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseOne" aria-expanded="false" aria-controls="flush-collapseOne">
											<div class=" col-11 d-flex justify-content-between align-items-baseline">

												@{
													int ratingCount = 0;
													float ratingTotal = 0;
													float averageRating = 0;
													foreach (ProductReviews productReview in ViewBag.ProductReviewsModel)
													{
														if (productReview.ProductId == ViewBag.Id)
														{
															ratingTotal += (float)productReview.Rating;
															ratingCount++;
														}

													}
													if(ratingCount != 0)
													{
														averageRating = ratingTotal / ratingCount;
													}
													
												}
												<h5>Reviews (@ratingCount)</h5>
												<div class="d-flex">
													<div class="rating">

														
														<div class="rating-upper" style="width: @(averageRating * 20)%">
															<span>★</span>
															<span>★</span>
															<span>★</span>
															<span>★</span>
															<span>★</span>
														</div>
														<div class="rating-lower">
															<span>★</span>
															<span>★</span>
															<span>★</span>
															<span>★</span>
															<span>★</span>
														</div>
													</div>
												</div>
											</div>
										</button>
									</h2>
									<div id="flush-collapseOne" class="accordion-collapse collapse" >
										@{
											bool alreadyReviewed = false;
										}
										@foreach (ProductReviews productReview in ViewBag.ProductReviewsModel)
										{
											if (productReview.Name == User.Identity?.Name)
											{
												alreadyReviewed = true;
												yourReviewId = productReview.Id;
											}
											else
											{

											}

											if (productReview.ProductId == ViewBag.Id)
											{
												<div class="accordion-body">
													<div class="d-flex justify-content-between align-items-baseline ">
														<h4 class="mb-0 review-name">@productReview.Name</h4>
														
														<div class="d-flex">
															<div class="rating">
																<div class="rating-upper"
																	 style="width: @(productReview.Rating * 20)%">
																	<span>★</span>
																	<span>★</span>
																	<span>★</span>
																	<span>★</span>
																	<span>★</span>
																</div>
																<div class="rating-lower">
																	<span>★</span>
																	<span>★</span>
																	<span>★</span>
																	<span>★</span>
																	<span>★</span>
																</div>
															</div>
														</div>
													</div>
													 <div>
														
														@if (productReview.Name == User.Identity?.Name)
														{
															<div class=" d-flex justify-content-start mb-3">
																<div style="cursor: pointer;" class="me-3" onclick="updateReview()" ><img class="review-operation-icon" src="~/assets/pencil-icon.png" /></div>
																<form asp-controller="ProductReviews" asp-action="Delete">
																	@{
																		int id2 = productReview.Id;
																	}
																	<input type="hidden" asp-for="@(id2)" />
																	<div class="">
																		<button type="submit" class="p-0 transparent-submit "><img class="review-operation-icon" src="~/assets/x-icon.png" /></button>
																	</div>
																</form>
															</div>
															<p id="yourMessage" class="review-message ">@productReview.Message</p>
														}
														else
														{
															<p class="review-message ">@productReview.Message</p>
														}

														
													</div>
														
													
													
												</div>
											}

										}
										<div id="updateEnterDiv" class="test23 mt-2 col-12 align-items-center flex-column">

											<h3 class="col-12 text-center ">Update your review: </h3>
											<form style=" height: fit-content;" class="col-10" asp-action="UpdateReview" method="post">
												<input type="hidden" id="Id" name="Id" value="@yourReviewId"><br>
												<input type="hidden" id="ProductId" name="ProductId" value="@ViewBag.Id"><br>
												<input type="hidden" id="Name" name="Name" value="@User.Identity?.Name"><br>
												<label for="Rating">★ Rating:</label><br>
												<div class="d-flex align-items-baseline">
													<input class="col-4 review-input" type="number" step="0.1" min="0" max="5" id="Rating" name="Rating" required>
												</div>
												<label class="mt-3" for="Message">Message:</label><br>
												<input style="height: 60px;" class=" col-12 review-input" type="text" id="Message" name="Message" required>
												<div class="mt-3 mb-3 form-group d-flex justify-content-end">
													<input type="submit" value="Submit" class="btn btn-primary" />
												</div>
											</form>
										</div>
										@if (alreadyReviewed)
										{
											canEditReview = true;
										}
										else
										{
											@if (SignInManager.IsSignedIn(User) && ratingCount > 0)
											{
												<div class="mt-2 col-12 d-flex align-items-center flex-column">

													<h3 class="col-12 text-center ">Leave a review: </h3>
													<form style=" height: fit-content;" class="col-10" asp-action="Review" method="post">

														<input type="hidden" id="ProductId" name="ProductId" value="@ViewBag.Id"><br>
														<input type="hidden" id="Name" name="Name" value="@User.Identity?.Name"><br>
														<label for="Rating">★ Rating:</label><br>
														<div class="d-flex align-items-baseline">
															<input class="col-4 review-input" type="number" step="0.1" min="0" max="5" id="Rating" name="Rating" required>
														</div>
														<label class="mt-3" for="Message">Message:</label><br>
														<input style="height: 60px;" class=" col-12 review-input" type="text" id="Message" name="Message" required>
														<div class="mt-3 mb-3 form-group d-flex justify-content-end">
															<input type="submit" value="Submit" class="btn btn-primary" />
														</div>
													</form>
												</div>
											}
										}
										@if (ratingCount == 0 && SignInManager.IsSignedIn(User))
										{
											<div class="mt-5 text-center">
												<h3>This product has not been reviewed yet. </h3>
												<h6>Be the first to review it. </h6>
											</div>

											<div class="mt-2 col-12 d-flex align-items-center flex-column">

												
												<form style="" class="col-10" asp-action="Review" method="post">

													<input type="hidden" id="ProductId" name="ProductId" value="@ViewBag.Id"><br>
													<input type="hidden" id="Name" name="Name" value="@User.Identity?.Name"><br>
													<label for="Rating">★ Rating:</label><br>
													<div class="d-flex align-items-baseline">
														<input class="col-4 review-input" type="number" step="0.1" min="0" max="5" id="Rating" name="Rating" required>
													</div>
													<label class="mt-3" for="Message">Message:</label><br>
													<input style="height: 60px;" class=" col-12 review-input" type="text" id="Message" name="Message" required>
													<div class="mt-3 mb-3 form-group d-flex justify-content-end">
														<input type="submit" value="Submit" class="btn btn-primary" />
													</div>
												</form>
											</div>
										}
										@if (!SignInManager.IsSignedIn(User))
										{
											<h6 class="mt-2 mb-2 text-center"><span class="text-danger">You must be logged in to leave a review!</span></h6>

										}

										
									</div>
									<div id="flush-collapseTwo" class="accordion-collapse collapse" >

									</div>
								</div>
								<div class="accordion-item">
									<h2 class="accordion-header">
										<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseThree" aria-expanded="false" aria-controls="flush-collapseThree">
											<div class=" col-11 d-flex justify-content-between align-items-baseline">


												<h5>Shipping</h5>
												</div>
										</button>
									</h2>
									<div id="flush-collapseThree" class="accordion-collapse collapse" >
										<div class="accordion-body">
											<p>
												Enjoy <span class="fw-bold">free shipping</span>  on orders of $50 or more. Shipping for items more expensive than $50 dollars are subject to fees depending on where you live.
											</p>
											<br>
											<p>Find out your shipping fees during <a asp-controller="ShoppingCart" asp-action="Index">checkout.</a></p>
											
										</div>
										
										
										
									</div>
								</div>
							</div>

							<p>@(product.Description)</p>


						}

					}
				}
			</div>

		</div>
		<div class="row col-12">
			<div class=" bg-secondary col-4">
				@foreach (ProductImages productImage in ViewBag.ProductImagesModel)
				{
					@foreach (Product product in ViewBag.ProductModel)
					{
						var temp = product.CategoryId;
						bool temp2 = temp == 1;
						if (temp2 && productImage.ProductId == product.Id && productImage.Id > 0 && ViewBag.Id == product.Id)
						{
							<h2 class="mb-0">@(product.Name) </h2>
							<h5 class=" ">@((product.Sex == 'M') ? "Men's" : (product.Sex == 'W') ? "Women's" : "Unisex") @(product.Type)s</h5>
							<h5>$@(product.Price) </h5>
							<p>@(product.Description)</p>


							<p>@(product.Description)</p> <p>@(product.Description)</p> <p>@(product.Description)</p>
							<p>@(product.Description)</p> <p>@(product.Description)</p> <p>@(product.Description)</p> <p>@(product.Description)</p> <p>@(product.Description)</p> <p>@(product.Description)</p>
						}



					}
				}
			</div>
		</div>

	</div>
</div>